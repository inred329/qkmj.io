<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QKMJ Minimal Web Client (Big5)</title>
  <!-- xterm.js æ ¸å¿ƒèˆ‡æ¨£å¼ï¼ˆCDNï¼‰ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
  <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit/lib/xterm-addon-fit.min.js"></script>
  <!-- Big5 è½‰ç¢¼å·¥å…·ï¼ˆencoding-japaneseï¼Œæ”¯æ´ BIG5ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/encoding-japanese/encoding.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; background: #0b0f14; color: #e6edf3; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .toolbar { display: flex; gap: .5rem; align-items: center; padding: .5rem .75rem; background: #0f1720; border-bottom: 1px solid #202938; }
    .toolbar input { flex: 1; min-width: 12rem; background: #0b1220; color: #e6edf3; border: 1px solid #263245; padding: .4rem .55rem; border-radius: .4rem; }
    .toolbar button { background: #1f6feb; color: white; border: 0; padding: .45rem .8rem; border-radius: .45rem; cursor: pointer; }
    .toolbar button:disabled { opacity: .5; cursor: not-allowed; }
    #term { height: calc(100% - 48px); padding: .5rem; }
    .status { font-size: 12px; opacity: .8; }
  </style>
</head>
<body>
  <div class="toolbar">
    <label class="status">WS URLï¼š</label>
    <input id="wsUrl" placeholder="ws://34.80.124.13:8081/" />
    <button id="btnConnect">Connect</button>
    <span class="status" id="statusText">æœªé€£ç·š</span>
  </div>
  <div id="term"></div>

  <script>
    // ====== åŸºæœ¬è¨­å®š ======
    const defaultHost = location.hostname || "34.80.124.13";
    const defaultWs = defaultHost ? `ws://${defaultHost}:8081/` : "ws://YOUR_IP:8081/";
    const wsInput = document.getElementById('wsUrl');
    wsInput.value = defaultWs;

    const term = new window.Terminal({
      convertEol: true,
      cursorBlink: true,
      fontFamily: 'Consolas, Menlo, Monaco, "Courier New", monospace',
      fontSize: 16,
      theme: { background: '#0b0f14', foreground: '#e6edf3' }
    });
    const fitAddon = new window.FitAddon.FitAddon();
    term.loadAddon(fitAddon);
    term.open(document.getElementById('term'));
    fitAddon.fit();
    window.addEventListener('resize', () => fitAddon.fit());

    const statusText = document.getElementById('statusText');
    const btnConnect = document.getElementById('btnConnect');

    let ws = null;

    function setStatus(txt) { statusText.textContent = txt; }

    // ---- Big5 è½‰ç¢¼å·¥å…· ----
    function big5DecodeChunk(u8) {
      // å„ªå…ˆä½¿ç”¨ encoding-japanese
      if (window.Encoding) {
        return window.Encoding.convert(u8, { to: 'UNICODE', from: 'BIG5', type: 'string' });
      }
      try {
        const dec = new TextDecoder('big5');
        return dec.decode(u8);
      } catch (_) {
        return new TextDecoder().decode(u8); // å¾Œå‚™ UTF-8
      }
    }

    function big5Encode(str) {
      if (window.Encoding) {
        return new Uint8Array(window.Encoding.convert(str, { to: 'BIG5', from: 'UNICODE', type: 'array' }));
      }
      return new TextEncoder().encode(str);
    }

    // ---- è§£æ±ºã€ŒBig5 å¤šä½å…ƒå­—åˆ‡åŒ…ã€ï¼šåšè¨Šæ¡†ç·©è¡ï¼Œé¿å…å¤šä½å…ƒå­—è¢«åˆ†å‰² ----
    let rxBuf = new Uint8Array(0);

    function appendBuffer(a, b) {
      const out = new Uint8Array(a.length + b.length);
      out.set(a, 0); out.set(b, a.length); return out;
    }

    function isLeadByte(byte) {
      // Big5 å‰å°ä½å…ƒï¼š0x81â€“0xFEï¼Œä½†ä¸å« 0x7Fï¼›ç°¡åŒ–è™•ç†
      return (byte >= 0x81 && byte <= 0xFE);
    }

    function flushDecode() {
      if (!rxBuf.length) return;
      // è‹¥æœ€å¾Œä¸€å€‹ä½å…ƒæ˜¯å‰å°ä½å…ƒï¼Œå…ˆä¸è¦è§£ï¼Œç­‰ä¸‹ä¸€åŒ…
      if (isLeadByte(rxBuf[rxBuf.length - 1])) return;
      term.write(big5DecodeChunk(rxBuf));
      rxBuf = new Uint8Array(0);
    }


    function connect() {
      const url = wsInput.value.trim();
      if (!url) return;
      try { new URL(url); } catch { setStatus('URL ç„¡æ•ˆ'); return; }

      if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) ws.close();
      ws = new WebSocket(url);
      ws.binaryType = 'arraybuffer';
      setStatus('é€£ç·šä¸­â€¦');
      btnConnect.disabled = true;

      ws.onopen = () => { setStatus('å·²é€£ç·š'); };

const big5Decoder = new TextDecoder('big5');

ws.onmessage = (ev) => {
  if (ev.data instanceof ArrayBuffer) {
    const text = big5Decoder.decode(new Uint8Array(ev.data), { stream: true });
    if (text) term.write(text);
  } else if (typeof ev.data === 'string') {
    term.write(ev.data);
  }
};

      ws.onclose = () => { setStatus('é€£ç·šé—œé–‰'); btnConnect.disabled = false; };
      ws.onerror = () => { setStatus('é€£ç·šéŒ¯èª¤'); btnConnect.disabled = false; };
    }

    btnConnect.addEventListener('click', connect);

    term.onData((data) => {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(big5Encode(data));
    });

    term.writeln('[1;36mQKMJ Minimal Web Client[0m');
    term.writeln('è«‹ç¢ºèªå¾Œç«¯å®¹å™¨åŸ æ˜ å°„ï¼š -p 8080:80ï¼Œä¸” GCP é˜²ç«ç‰†å·²é–‹ tcp:8080');
    term.writeln('åœ¨ä¸Šæ–¹è¼¸å…¥ ws://<ä½ çš„å¤–éƒ¨IP>:8080/ å¾ŒæŒ‰ Connect');
  </script>
</body>
</html>
